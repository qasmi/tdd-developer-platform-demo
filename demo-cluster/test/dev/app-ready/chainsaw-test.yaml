# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: app-ready
spec:
  concurrent: false
  steps:
  - try:
    - create:
        resource:
          apiVersion: database.kubecon.io/v1alpha1
          kind: MariaDBInstance
          metadata:
            name: drupal-db
          spec:
            parameters:
              database: "drupal"
              username: "drupal"
              size: "4Gi"
    - assert:
        timeout: 2m
        resource:
          apiVersion: database.kubecon.io/v1alpha1
          kind: MariaDBInstance
          metadata:
            name: drupal-db
          status:
            (conditions[?type == 'Ready']):
            - status: 'True'
    - script:
        timeout: 3m
        content: |
          helm install app-dev \
            --namespace $NAMESPACE \
            --wait \
            --timeout 15m \
            --atomic \
            oci://registry-1.docker.io/bitnamicharts/drupal \
            --version 23.0.0 \
            --values ../../../../demo-cluster/manifests/dev/drupal-values.yaml
