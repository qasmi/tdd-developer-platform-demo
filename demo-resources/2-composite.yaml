apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: xdatabases.example.org
spec:
  group: example.org
  names:
    kind: XDatabase
    plural: xdatabases
  defaultCompositionRef:
    name: mariadbcomposition
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                storage:
                  type: string
                  default: "1Gi"
                dbName:
                  type: string
                  default: "drupal"
                user:
                  type: string
                  default: "drupal"
                password:
                  type: string
                  default: "drupalpass"
              required: ["dbName", "user", "password"]
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: mariadbcomposition
spec:
  compositeTypeRef:
    apiVersion: example.org/v1alpha1
    kind: XDatabase
  mode: Pipeline
  pipeline:
    - step: render-secret
      functionRef:
        name: crossplane-contrib-function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            apiVersion: v1
            kind: Secret
            metadata:
              name: mariadb-secret
              namespace: {{ .observed.resource.metadata.namespace }}
            stringData:
              root-password: rootpass
              username: {{ .observed.resource.spec.user }}
              password: {{ .observed.resource.spec.password }}
              database: {{ .observed.resource.spec.dbName }}
    - step: apply-mariadb
      functionRef:
        name: crossplane-contrib-function-kubernetes-apply
      input:
        apiVersion: fn.crossplane.io/v1beta1
        kind: RunFunctionRequest
        manifests:
          - apiVersion: apps/v1
            kind: StatefulSet
            metadata:
              name: "mariadb"
              namespace: "{{ .observed.resource.metadata.namespace }}"
              labels:
                app: mariadb
            spec:
              selector:
                matchLabels:
                  app: mariadb
              serviceName: "mariadb"
              replicas: 1
              template:
                metadata:
                  labels:
                    app: mariadb
                spec:
                  containers:
                    - name: mariadb
                      image: "mariadb:11.3"
                      ports:
                        - containerPort: 3306
                          name: mysql
                      env:
                        - name: MYSQL_ROOT_PASSWORD
                          valueFrom:
                            secretKeyRef:
                              name: mariadb-secret
                              key: root-password
                        - name: MYSQL_DATABASE
                          valueFrom:
                            secretKeyRef:
                              name: mariadb-secret
                              key: database
                        - name: MYSQL_USER
                          valueFrom:
                            secretKeyRef:
                              name: mariadb-secret
                              key: username
                        - name: MYSQL_PASSWORD
                          valueFrom:
                            secretKeyRef:
                              name: mariadb-secret
                              key: password
                      volumeMounts:
                        - name: data
                          mountPath: /var/lib/mysql
              volumeClaimTemplates:
                - metadata:
                    name: data
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: "{{ .observed.resource.spec.storage }}"
          - apiVersion: v1
            kind: Service
            metadata:
              name: "mariadb"
              namespace: "{{ .observed.resource.metadata.namespace }}"
              labels:
                app: mariadb
            spec:
              ports:
                - port: 3306
                  targetPort: mysql
              selector:
                app: mariadb
